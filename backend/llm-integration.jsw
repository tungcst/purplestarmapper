// æ˜Ÿé€”ç¾…ç›¤ LLM API é›†æˆæ¨¡å¡Š
// ç”¨æ–¼èˆ‡è‡ªç ”å¤§å‹èªè¨€æ¨¡å‹ API é€šä¿¡ï¼Œç”Ÿæˆå‘½ç†å ±å‘Š

import { fetch } from 'wix-fetch';
import { saveUserReport, saveOrUpdateBirthData } from 'backend/database';

// LLM API é…ç½®
const LLM_CONFIG = {
    baseUrl: process.env.LLM_API_BASE_URL || 'https://your-llm-api.com/api/v1',
    apiKey: process.env.LLM_API_KEY || 'your-api-key-here',
    timeout: 30000, // 30 seconds
    maxRetries: 3
};

// å ±å‘Šé¡å‹å®šç¾©
export const REPORT_TYPES = {
    ZIWEI: 'ziwei',           // ç´«å¾®æ–—æ•¸å…¨é¢åˆ†æ
    CAREER: 'career',         // äº‹æ¥­é‹å‹¢åˆ†æ
    LOVE: 'love',             // æ„›æƒ…é—œä¿‚åˆ†æ
    HEALTH: 'health',         // å¥åº·é‹å‹¢åˆ†æ
    WEALTH: 'wealth'          // è²¡é‹åˆ†æ
};

// ç”Ÿæˆå ±å‘Šçš„ä¸»å‡½æ•¸
export async function generateReport(userId, birthData, reportType, options = {}) {
    try {
        console.log(`ğŸ¯ Starting report generation for user ${userId}, type: ${reportType}`);
        
        // é©—è­‰è¼¸å…¥æ•¸æ“š
        validateBirthData(birthData);
        validateReportType(reportType);
        
        // ä¿å­˜æˆ–æ›´æ–°ç”Ÿè¾°æ•¸æ“š
        const savedBirthData = await saveOrUpdateBirthData({
            ...birthData,
            userId
        });
        
        // æº–å‚™ LLM API è«‹æ±‚
        const prompt = buildPrompt(birthData, reportType, options);
        
        // èª¿ç”¨ LLM API
        const llmResponse = await callLLMAPI(prompt, reportType);
        
        // è™•ç†éŸ¿æ‡‰ä¸¦åˆ†å‰²ç‚ºè©¦é–±ç‰ˆå’Œå®Œæ•´ç‰ˆ
        const processedReport = processLLMResponse(llmResponse, reportType);
        
        // ä¿å­˜å ±å‘Šåˆ°æ•¸æ“šåº«
        const reportData = {
            userId,
            reportType,
            birthDataId: savedBirthData._id,
            status: 'trial',
            trialContent: JSON.stringify(processedReport.trial),
            fullContent: JSON.stringify(processedReport.full),
            metadata: {
                llmModel: llmResponse.model,
                promptTokens: llmResponse.usage?.prompt_tokens,
                completionTokens: llmResponse.usage?.completion_tokens,
                generationTime: new Date().toISOString(),
                options
            }
        };
        
        const savedReport = await saveUserReport(reportData);
        
        console.log('âœ… Report generated successfully:', savedReport.reportId);
        
        return {
            success: true,
            reportId: savedReport.reportId,
            trial: processedReport.trial,
            full: null, // å®Œæ•´ç‰ˆéœ€è¦ä»˜è²»è§£é–
            metadata: reportData.metadata
        };
        
    } catch (error) {
        console.error('âŒ Error generating report:', error);
        throw new Error(`å ±å‘Šç”Ÿæˆå¤±æ•—: ${error.message}`);
    }
}

// é©—è­‰ç”Ÿè¾°æ•¸æ“š
function validateBirthData(birthData) {
    const required = ['birthDate', 'birthTime', 'gender'];
    const missing = required.filter(field => !birthData[field] && birthData[field] !== 0);
    
    if (missing.length > 0) {
        throw new Error(`ç¼ºå°‘å¿…è¦çš„ç”Ÿè¾°ä¿¡æ¯: ${missing.join(', ')}`);
    }
    
    // é©—è­‰æ—¥æœŸæ ¼å¼
    if (!/^\d{4}-\d{2}-\d{2}$/.test(birthData.birthDate)) {
        throw new Error('ç”Ÿè¾°æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œæ‡‰ç‚º YYYY-MM-DD');
    }
    
    // é©—è­‰æ™‚è¾°
    const timeIndex = parseInt(birthData.birthTime);
    if (isNaN(timeIndex) || timeIndex < 0 || timeIndex > 11) {
        throw new Error('ç”Ÿè¾°æ™‚è¾°éŒ¯èª¤ï¼Œæ‡‰ç‚º 0-11');
    }
    
    // é©—è­‰æ€§åˆ¥
    if (!['M', 'F', 'male', 'female'].includes(birthData.gender)) {
        throw new Error('æ€§åˆ¥ä¿¡æ¯éŒ¯èª¤');
    }
}

// é©—è­‰å ±å‘Šé¡å‹
function validateReportType(reportType) {
    if (!Object.values(REPORT_TYPES).includes(reportType)) {
        throw new Error(`ä¸æ”¯æŒçš„å ±å‘Šé¡å‹: ${reportType}`);
    }
}

// æ§‹å»º LLM æç¤ºè©
function buildPrompt(birthData, reportType, options) {
    const basePrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç´«å¾®æ–—æ•¸å‘½ç†å¸«ï¼Œæ“æœ‰è±å¯Œçš„å‘½ç†çŸ¥è­˜å’Œç¶“é©—ã€‚è«‹åŸºæ–¼ä»¥ä¸‹ç”Ÿè¾°ä¿¡æ¯ç”Ÿæˆå°ˆæ¥­çš„å‘½ç†åˆ†æå ±å‘Šï¼š

ç”Ÿè¾°ä¿¡æ¯ï¼š
- å‡ºç”Ÿæ—¥æœŸï¼š${birthData.birthDate}
- å‡ºç”Ÿæ™‚è¾°ï¼š${getTimeHourName(birthData.birthTime)}
- æ€§åˆ¥ï¼š${birthData.gender === 'M' || birthData.gender === 'male' ? 'ç”·' : 'å¥³'}
- æ›†æ³•ï¼š${birthData.solar !== false ? 'å…¬æ›†' : 'è¾²æ›†'}

è«‹ç”Ÿæˆ${getReportTypeName(reportType)}å ±å‘Šï¼Œå…§å®¹éœ€è¦ï¼š
1. å°ˆæ¥­æº–ç¢ºï¼Œç¬¦åˆç´«å¾®æ–—æ•¸ç†è«–
2. èªè¨€å„ªç¾ï¼Œæ˜“æ–¼ç†è§£
3. çµæ§‹æ¸…æ™°ï¼Œå±¤æ¬¡åˆ†æ˜
4. åŒ…å«å…·é«”çš„åˆ†æå’Œå»ºè­°

è«‹ä»¥ JSON æ ¼å¼è¿”å›çµæœï¼ŒåŒ…å«ä»¥ä¸‹çµæ§‹ï¼š
{
  "title": "å ±å‘Šæ¨™é¡Œ",
  "summary": "ç°¡è¦ç¸½çµ",
  "sections": [
    {
      "title": "ç« ç¯€æ¨™é¡Œ",
      "content": "è©³ç´°å…§å®¹",
      "highlights": ["é‡é»1", "é‡é»2"]
    }
  ],
  "recommendations": ["å»ºè­°1", "å»ºè­°2"],
  "lucky_elements": {
    "colors": ["é¡è‰²1", "é¡è‰²2"],
    "numbers": [æ•¸å­—1, æ•¸å­—2],
    "directions": ["æ–¹ä½1", "æ–¹ä½2"]
  }
}`;

    // æ ¹æ“šå ±å‘Šé¡å‹æ·»åŠ ç‰¹å®šæç¤º
    const typeSpecificPrompts = {
        [REPORT_TYPES.ZIWEI]: 'é‡é»åˆ†æå‘½å®®ã€è²¡å¸›å®®ã€äº‹æ¥­å®®ã€é·ç§»å®®ç­‰ä¸»è¦å®®ä½ï¼Œä»¥åŠä¸»æ˜Ÿçš„å½±éŸ¿ã€‚',
        [REPORT_TYPES.CAREER]: 'é‡é»åˆ†æäº‹æ¥­å®®ã€å®˜ç¥¿å®®ã€è²¡å¸›å®®ï¼Œä»¥åŠå½±éŸ¿äº‹æ¥­ç™¼å±•çš„æ˜Ÿæ›œçµ„åˆã€‚',
        [REPORT_TYPES.LOVE]: 'é‡é»åˆ†æå¤«å¦»å®®ã€ç¦å¾·å®®ã€å­å¥³å®®ï¼Œä»¥åŠæ„Ÿæƒ…é‹å‹¢å’Œå©šå§»ç‹€æ³ã€‚',
        [REPORT_TYPES.HEALTH]: 'é‡é»åˆ†æç–¾å„å®®ã€çˆ¶æ¯å®®ï¼Œä»¥åŠå½±éŸ¿å¥åº·çš„æ˜Ÿæ›œé…ç½®ã€‚',
        [REPORT_TYPES.WEALTH]: 'é‡é»åˆ†æè²¡å¸›å®®ã€ç”°å®…å®®ï¼Œä»¥åŠè²¡é‹èµ°å‹¢å’Œç†è²¡å»ºè­°ã€‚'
    };

    return basePrompt + '\n\n' + typeSpecificPrompts[reportType];
}

// æ™‚è¾°åç¨±å°ç…§
function getTimeHourName(timeIndex) {
    const timeNames = [
        'å­æ™‚ (23:00-01:00)', 'ä¸‘æ™‚ (01:00-03:00)', 'å¯…æ™‚ (03:00-05:00)',
        'å¯æ™‚ (05:00-07:00)', 'è¾°æ™‚ (07:00-09:00)', 'å·³æ™‚ (09:00-11:00)',
        'åˆæ™‚ (11:00-13:00)', 'æœªæ™‚ (13:00-15:00)', 'ç”³æ™‚ (15:00-17:00)',
        'é…‰æ™‚ (17:00-19:00)', 'æˆŒæ™‚ (19:00-21:00)', 'äº¥æ™‚ (21:00-23:00)'
    ];
    return timeNames[parseInt(timeIndex)] || 'æœªçŸ¥æ™‚è¾°';
}

// å ±å‘Šé¡å‹åç¨±å°ç…§
function getReportTypeName(reportType) {
    const typeNames = {
        [REPORT_TYPES.ZIWEI]: 'ç´«å¾®æ–—æ•¸å…¨é¢åˆ†æ',
        [REPORT_TYPES.CAREER]: 'äº‹æ¥­é‹å‹¢åˆ†æ',
        [REPORT_TYPES.LOVE]: 'æ„›æƒ…é—œä¿‚åˆ†æ',
        [REPORT_TYPES.HEALTH]: 'å¥åº·é‹å‹¢åˆ†æ',
        [REPORT_TYPES.WEALTH]: 'è²¡é‹åˆ†æ'
    };
    return typeNames[reportType] || 'å‘½ç†åˆ†æ';
}

// èª¿ç”¨ LLM API
async function callLLMAPI(prompt, reportType, retryCount = 0) {
    try {
        const requestBody = {
            model: 'gpt-4o-mini', // æˆ–æ‚¨çš„æ¨¡å‹åç¨±
            messages: [
                {
                    role: 'system',
                    content: 'ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç´«å¾®æ–—æ•¸å‘½ç†å¸«ï¼Œè«‹åŸºæ–¼ç”¨æˆ¶æä¾›çš„ç”Ÿè¾°ä¿¡æ¯ç”Ÿæˆæº–ç¢ºã€å°ˆæ¥­çš„å‘½ç†åˆ†æå ±å‘Šã€‚'
                },
                {
                    role: 'user',
                    content: prompt
                }
            ],
            temperature: 0.7,
            max_tokens: 2000,
            response_format: { type: "json_object" }
        };

        const response = await fetch(`${LLM_CONFIG.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${LLM_CONFIG.apiKey}`
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`LLM API è«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('LLM API è¿”å›æ•¸æ“šæ ¼å¼éŒ¯èª¤');
        }

        return {
            content: data.choices[0].message.content,
            model: data.model,
            usage: data.usage
        };

    } catch (error) {
        if (retryCount < LLM_CONFIG.maxRetries) {
            console.log(`ğŸ”„ Retrying LLM API call (${retryCount + 1}/${LLM_CONFIG.maxRetries})`);
            await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
            return callLLMAPI(prompt, reportType, retryCount + 1);
        }
        
        console.error('âŒ LLM API call failed after retries:', error);
        throw error;
    }
}

// è™•ç† LLM éŸ¿æ‡‰
function processLLMResponse(llmResponse, reportType) {
    try {
        const report = JSON.parse(llmResponse.content);
        
        // å‰µå»ºè©¦é–±ç‰ˆï¼ˆé™åˆ¶å…§å®¹é•·åº¦ï¼‰
        const trial = {
            title: report.title,
            summary: report.summary,
            sections: report.sections ? report.sections.slice(0, 2).map(section => ({
                ...section,
                content: section.content ? section.content.substring(0, 200) + '...' : ''
            })) : [],
            preview_note: 'é€™æ˜¯è©¦é–±ç‰ˆæœ¬ï¼Œå®Œæ•´å ±å‘ŠåŒ…å«æ›´å¤šè©³ç´°åˆ†æå’Œå»ºè­°ã€‚'
        };

        // å®Œæ•´ç‰ˆåŒ…å«æ‰€æœ‰å…§å®¹
        const full = {
            ...report,
            generation_time: new Date().toISOString(),
            report_type: reportType
        };

        return { trial, full };

    } catch (error) {
        console.error('âŒ Error processing LLM response:', error);
        
        // å¦‚æœè§£æå¤±æ•—ï¼Œè¿”å›åŸºæœ¬çµæ§‹
        return {
            trial: {
                title: `${getReportTypeName(reportType)}å ±å‘Š`,
                summary: 'å ±å‘Šç”Ÿæˆä¸­é‡åˆ°å•é¡Œï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚',
                sections: [],
                preview_note: 'é€™æ˜¯è©¦é–±ç‰ˆæœ¬ï¼Œå®Œæ•´å ±å‘ŠåŒ…å«æ›´å¤šè©³ç´°åˆ†æå’Œå»ºè­°ã€‚'
            },
            full: {
                title: `${getReportTypeName(reportType)}å ±å‘Š`,
                error: 'å ±å‘Šå…§å®¹è§£æå¤±æ•—',
                raw_response: llmResponse.content
            }
        };
    }
}

// ç²å–è©¦é–±å ±å‘Šï¼ˆä¸éœ€è¦ä»˜è²»ï¼‰
export async function getTrialReport(reportId) {
    try {
        const report = await getReportByReportId(reportId);
        
        if (!report) {
            throw new Error('å ±å‘Šä¸å­˜åœ¨');
        }

        const trialContent = JSON.parse(report.trialContent);
        
        return {
            success: true,
            reportId: report.reportId,
            reportType: report.reportType,
            content: trialContent,
            status: report.status,
            generatedAt: report.generatedAt
        };

    } catch (error) {
        console.error('âŒ Error getting trial report:', error);
        throw new Error(`ç²å–è©¦é–±å ±å‘Šå¤±æ•—: ${error.message}`);
    }
}

// ç²å–å®Œæ•´å ±å‘Šï¼ˆéœ€è¦ä»˜è²»ï¼‰
export async function getFullReport(reportId, userId) {
    try {
        const report = await getReportByReportId(reportId);
        
        if (!report) {
            throw new Error('å ±å‘Šä¸å­˜åœ¨');
        }

        if (report.userId !== userId) {
            throw new Error('ç„¡æ¬Šé™è¨ªå•æ­¤å ±å‘Š');
        }

        if (report.status !== 'paid') {
            throw new Error('è«‹å…ˆå®Œæˆä»˜è²»æ‰èƒ½æŸ¥çœ‹å®Œæ•´å ±å‘Š');
        }

        const fullContent = JSON.parse(report.fullContent);
        
        return {
            success: true,
            reportId: report.reportId,
            reportType: report.reportType,
            content: fullContent,
            status: report.status,
            generatedAt: report.generatedAt,
            paidAt: report.paidAt
        };

    } catch (error) {
        console.error('âŒ Error getting full report:', error);
        throw new Error(`ç²å–å®Œæ•´å ±å‘Šå¤±æ•—: ${error.message}`);
    }
}

// æ¸¬è©¦ LLM API é€£æ¥
export async function testLLMConnection() {
    try {
        const testPrompt = 'è«‹å›ç­”ï¼šä½ å¥½ï¼Œé€™æ˜¯ä¸€å€‹APIé€£æ¥æ¸¬è©¦ã€‚è«‹ç°¡çŸ­å›å¾©ç¢ºèªæ”¶åˆ°ã€‚';
        
        const response = await callLLMAPI(testPrompt, 'test');
        
        return {
            success: true,
            message: 'LLM API é€£æ¥æ­£å¸¸',
            response: response.content,
            model: response.model
        };

    } catch (error) {
        console.error('âŒ LLM API connection test failed:', error);
        return {
            success: false,
            message: 'LLM API é€£æ¥å¤±æ•—',
            error: error.message
        };
    }
} 