// æ˜Ÿé€”ç¾…ç›¤æ•¸æ“šåº«é…ç½®èˆ‡ç®¡ç†
// ç”¨æ–¼å­˜å„²ç”¨æˆ¶ç”Ÿæˆçš„å‘½ç†å ±å‘Šå’Œç›¸é—œæ•¸æ“š

import wixData from 'wix-data';

// æ•¸æ“šé›†åç¨±å®šç¾©
export const COLLECTIONS = {
    USER_REPORTS: 'UserReports',          // ç”¨æˆ¶å ±å‘Šè¨˜éŒ„
    BIRTH_DATA: 'BirthData',             // ç”Ÿè¾°æ•¸æ“š
    REPORT_TEMPLATES: 'ReportTemplates',  // å ±å‘Šæ¨¡æ¿
    USER_SESSIONS: 'UserSessions'         // ç”¨æˆ¶æœƒè©±è¨˜éŒ„
};

// UserReports æ•¸æ“šçµæ§‹
export const USER_REPORTS_SCHEMA = {
    _id: 'string',                    // ç³»çµ±è‡ªå‹•ç”Ÿæˆ
    userId: 'string',                 // ç”¨æˆ¶ID (ä¾†è‡ª Wix Members)
    reportId: 'string',               // å ±å‘Šå”¯ä¸€æ¨™è­˜
    reportType: 'string',             // å ±å‘Šé¡å‹: 'ziwei', 'career', 'love'
    birthDataId: 'string',            // é—œè¯çš„ç”Ÿè¾°æ•¸æ“šID
    status: 'string',                 // ç‹€æ…‹: 'trial', 'paid', 'generated', 'error'
    trialContent: 'text',             // è©¦é–±å…§å®¹ (JSON æ ¼å¼)
    fullContent: 'text',              // å®Œæ•´å ±å‘Šå…§å®¹ (JSON æ ¼å¼)
    generatedAt: 'datetime',          // ç”Ÿæˆæ™‚é–“
    paidAt: 'datetime',               // ä»˜è²»æ™‚é–“
    paymentAmount: 'number',          // ä»˜è²»é‡‘é¡
    paymentCurrency: 'string',        // ä»˜è²»è²¨å¹£
    isActive: 'boolean',              // æ˜¯å¦æœ‰æ•ˆ
    metadata: 'text'                  // é¡å¤–å…ƒæ•¸æ“š (JSON æ ¼å¼)
};

// BirthData æ•¸æ“šçµæ§‹
export const BIRTH_DATA_SCHEMA = {
    _id: 'string',                    // ç³»çµ±è‡ªå‹•ç”Ÿæˆ
    userId: 'string',                 // ç”¨æˆ¶ID
    dataHash: 'string',               // ç”Ÿè¾°æ•¸æ“šå“ˆå¸Œå€¼ï¼ˆç”¨æ–¼å»é‡ï¼‰
    birthDate: 'string',              // å‡ºç”Ÿæ—¥æœŸ YYYY-MM-DD
    birthTime: 'string',              // å‡ºç”Ÿæ™‚è¾° (0-11)
    gender: 'string',                 // æ€§åˆ¥ M/F
    solar: 'boolean',                 // æ˜¯å¦å…¬æ›†
    birthLocation: 'text',            // å‡ºç”Ÿåœ°é» (JSON æ ¼å¼)
    timezone: 'string',               // æ™‚å€
    createdAt: 'datetime',            // å‰µå»ºæ™‚é–“
    isEncrypted: 'boolean',           // æ˜¯å¦åŠ å¯†å­˜å„²
    usageCount: 'number'              // ä½¿ç”¨æ¬¡æ•¸
};

// ç”¨æˆ¶å ±å‘Šç®¡ç†å‡½æ•¸
export async function saveUserReport(reportData) {
    try {
        // é©—è­‰å¿…è¦å­—æ®µ
        if (!reportData.userId || !reportData.reportType || !reportData.birthDataId) {
            throw new Error('Missing required fields for user report');
        }

        // ç”Ÿæˆå”¯ä¸€å ±å‘ŠID
        const reportId = generateReportId(reportData.reportType);
        
        const reportRecord = {
            reportId,
            userId: reportData.userId,
            reportType: reportData.reportType,
            birthDataId: reportData.birthDataId,
            status: reportData.status || 'trial',
            trialContent: reportData.trialContent || '',
            fullContent: reportData.fullContent || '',
            generatedAt: new Date(),
            isActive: true,
            metadata: JSON.stringify(reportData.metadata || {})
        };

        const result = await wixData.insert(COLLECTIONS.USER_REPORTS, reportRecord);
        console.log('âœ… User report saved:', result._id);
        return result;
    } catch (error) {
        console.error('âŒ Error saving user report:', error);
        throw error;
    }
}

export async function getBirthDataByUserId(userId) {
    try {
        const results = await wixData.query(COLLECTIONS.BIRTH_DATA)
            .eq('userId', userId)
            .descending('createdAt')
            .find();
        
        return results.items;
    } catch (error) {
        console.error('âŒ Error fetching birth data:', error);
        throw error;
    }
}

export async function saveOrUpdateBirthData(birthData) {
    try {
        // ç”Ÿæˆæ•¸æ“šå“ˆå¸Œå€¼ç”¨æ–¼å»é‡
        const dataHash = generateBirthDataHash(birthData);
        
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ç”Ÿè¾°æ•¸æ“š
        const existingData = await wixData.query(COLLECTIONS.BIRTH_DATA)
            .eq('userId', birthData.userId)
            .eq('dataHash', dataHash)
            .find();

        if (existingData.items.length > 0) {
            // æ›´æ–°ä½¿ç”¨æ¬¡æ•¸
            const existing = existingData.items[0];
            existing.usageCount = (existing.usageCount || 0) + 1;
            
            const updated = await wixData.update(COLLECTIONS.BIRTH_DATA, existing);
            console.log('ğŸ“Š Birth data usage updated:', updated._id);
            return updated;
        } else {
            // å‰µå»ºæ–°è¨˜éŒ„
            const birthRecord = {
                userId: birthData.userId,
                dataHash,
                birthDate: birthData.birthDate,
                birthTime: birthData.birthTime.toString(),
                gender: birthData.gender,
                solar: birthData.solar !== false,
                birthLocation: JSON.stringify(birthData.birthLocation || {}),
                timezone: birthData.timezone || 'UTC+8',
                createdAt: new Date(),
                isEncrypted: false,
                usageCount: 1
            };

            const result = await wixData.insert(COLLECTIONS.BIRTH_DATA, birthRecord);
            console.log('âœ… Birth data saved:', result._id);
            return result;
        }
    } catch (error) {
        console.error('âŒ Error saving birth data:', error);
        throw error;
    }
}

export async function getUserReports(userId, reportType = null) {
    try {
        let query = wixData.query(COLLECTIONS.USER_REPORTS)
            .eq('userId', userId)
            .eq('isActive', true)
            .descending('generatedAt');

        if (reportType) {
            query = query.eq('reportType', reportType);
        }

        const results = await query.find();
        return results.items;
    } catch (error) {
        console.error('âŒ Error fetching user reports:', error);
        throw error;
    }
}

export async function updateReportStatus(reportId, status, additionalData = {}) {
    try {
        const report = await wixData.query(COLLECTIONS.USER_REPORTS)
            .eq('reportId', reportId)
            .find();

        if (report.items.length === 0) {
            throw new Error(`Report not found: ${reportId}`);
        }

        const updateData = {
            _id: report.items[0]._id,
            status,
            ...additionalData
        };

        if (status === 'paid') {
            updateData.paidAt = new Date();
        }

        const result = await wixData.update(COLLECTIONS.USER_REPORTS, updateData);
        console.log('âœ… Report status updated:', result._id);
        return result;
    } catch (error) {
        console.error('âŒ Error updating report status:', error);
        throw error;
    }
}

export async function getReportByReportId(reportId) {
    try {
        const results = await wixData.query(COLLECTIONS.USER_REPORTS)
            .eq('reportId', reportId)
            .eq('isActive', true)
            .find();

        if (results.items.length === 0) {
            return null;
        }

        return results.items[0];
    } catch (error) {
        console.error('âŒ Error fetching report by ID:', error);
        throw error;
    }
}

// ç”¨æˆ¶æœƒè©±ç®¡ç†
export async function saveUserSession(sessionData) {
    try {
        const sessionRecord = {
            userId: sessionData.userId || 'anonymous',
            sessionId: sessionData.sessionId || generateSessionId(),
            actionType: sessionData.actionType, // 'visit', 'generate_trial', 'purchase', etc.
            pageUrl: sessionData.pageUrl || '',
            userAgent: sessionData.userAgent || '',
            ipAddress: sessionData.ipAddress || '',
            referrer: sessionData.referrer || '',
            timestamp: new Date(),
            metadata: JSON.stringify(sessionData.metadata || {})
        };

        const result = await wixData.insert(COLLECTIONS.USER_SESSIONS, sessionRecord);
        return result;
    } catch (error) {
        console.error('âŒ Error saving user session:', error);
        throw error;
    }
}

// è¼”åŠ©å‡½æ•¸
function generateReportId(reportType) {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    return `${reportType}_${timestamp}_${random}`;
}

function generateBirthDataHash(birthData) {
    const hashInput = [
        birthData.birthDate,
        birthData.birthTime,
        birthData.gender,
        birthData.solar ? 'solar' : 'lunar'
    ].join('|');
    
    // ç°¡å–®å“ˆå¸Œå‡½æ•¸ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­å»ºè­°ä½¿ç”¨æ›´å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼‰
    let hash = 0;
    for (let i = 0; i < hashInput.length; i++) {
        const char = hashInput.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // è½‰æ›ç‚º32ä½æ•´æ•¸
    }
    return hash.toString();
}

function generateSessionId() {
    return Date.now().toString() + '_' + Math.random().toString(36).substring(2, 15);
}

// æ•¸æ“šæ¸…ç†å’Œç¶­è­·å‡½æ•¸
export async function cleanupOldSessions(daysOld = 30) {
    try {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - daysOld);

        const oldSessions = await wixData.query(COLLECTIONS.USER_SESSIONS)
            .lt('timestamp', cutoffDate)
            .find();

        if (oldSessions.items.length > 0) {
            const idsToDelete = oldSessions.items.map(item => item._id);
            await wixData.bulkRemove(COLLECTIONS.USER_SESSIONS, idsToDelete);
            console.log(`ğŸ§¹ Cleaned up ${idsToDelete.length} old sessions`);
        }

        return oldSessions.items.length;
    } catch (error) {
        console.error('âŒ Error cleaning up old sessions:', error);
        throw error;
    }
}

// çµ±è¨ˆå‡½æ•¸
export async function getReportStats(userId = null) {
    try {
        let query = wixData.query(COLLECTIONS.USER_REPORTS)
            .eq('isActive', true);

        if (userId) {
            query = query.eq('userId', userId);
        }

        const allReports = await query.find();
        const reports = allReports.items;

        const stats = {
            total: reports.length,
            byType: {},
            byStatus: {},
            recentActivity: reports.filter(r => {
                const dayAgo = new Date();
                dayAgo.setDate(dayAgo.getDate() - 1);
                return r.generatedAt > dayAgo;
            }).length
        };

        // æŒ‰é¡å‹çµ±è¨ˆ
        reports.forEach(report => {
            stats.byType[report.reportType] = (stats.byType[report.reportType] || 0) + 1;
            stats.byStatus[report.status] = (stats.byStatus[report.status] || 0) + 1;
        });

        return stats;
    } catch (error) {
        console.error('âŒ Error getting report stats:', error);
        throw error;
    }
} 