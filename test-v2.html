<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿé€”ç¾…ç›¤ v2.0 æ¸¬è©¦é é¢</title>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f3ff, #faf5ff, #f0f9ff);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(88, 28, 135, 0.1);
        }
        
        .header h1 {
            color: #581C87;
            margin: 0 0 10px 0;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .header p {
            color: #6B21A8;
            margin: 0;
            font-size: 1.1rem;
        }
        
        .test-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(88, 28, 135, 0.1);
        }
        
        .test-section h2 {
            color: #581C87;
            margin: 0 0 20px 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #581C87;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #581C87, #6B21A8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #6B21A8, #7C3AED);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 28, 135, 0.3);
        }
        
        .btn-secondary {
            background: #F3F4F6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #E5E7EB;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.2);
        }
        
        .chart-container {
            width: 100%;
            height: 600px;
            border: 2px solid rgba(230, 230, 250, 0.8);
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .debug-info {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status.success {
            background: #ECFDF5;
            color: #059669;
            border: 1px solid #A7F3D0;
        }
        
        .status.error {
            background: #FEF2F2;
            color: #DC2626;
            border: 1px solid #FECACA;
        }
        
        .status.info {
            background: #EFF6FF;
            color: #2563EB;
            border: 1px solid #BFDBFE;
        }
        
        .preset-buttons {
            margin: 20px 0;
        }
        
        .preset-buttons .btn {
            font-size: 14px;
            padding: 8px 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ æ˜Ÿé€”ç¾…ç›¤ v2.0 æ¸¬è©¦é é¢</h1>
            <p>æ¸¬è©¦å¢å¼·ç‰ˆç´«å¾®åœ–è¡¨ Custom Element - è§£æ±º IZTRO å‘½ç›¤é¡¯ç¤ºçµæ§‹éŒ¯èª¤å•é¡Œ</p>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š ç”Ÿè¾°æ•¸æ“šè¼¸å…¥</h2>
            <form id="birthForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="birthDate">å‡ºç”Ÿæ—¥æœŸï¼š</label>
                        <input type="date" id="birthDate" name="birthDate" value="1990-01-15" required>
                    </div>
                    <div class="form-group">
                        <label for="birthTime">å‡ºç”Ÿæ™‚è¾°ï¼š</label>
                        <select id="birthTime" name="birthTime" required>
                            <option value="0">å­æ™‚ (23:00-01:00)</option>
                            <option value="1">ä¸‘æ™‚ (01:00-03:00)</option>
                            <option value="2">å¯…æ™‚ (03:00-05:00)</option>
                            <option value="3" selected>å¯æ™‚ (05:00-07:00)</option>
                            <option value="4">è¾°æ™‚ (07:00-09:00)</option>
                            <option value="5">å·³æ™‚ (09:00-11:00)</option>
                            <option value="6">åˆæ™‚ (11:00-13:00)</option>
                            <option value="7">æœªæ™‚ (13:00-15:00)</option>
                            <option value="8">ç”³æ™‚ (15:00-17:00)</option>
                            <option value="9">é…‰æ™‚ (17:00-19:00)</option>
                            <option value="10">æˆŒæ™‚ (19:00-21:00)</option>
                            <option value="11">äº¥æ™‚ (21:00-23:00)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">æ€§åˆ¥ï¼š</label>
                        <select id="gender" name="gender" required>
                            <option value="M" selected>ç”·æ€§</option>
                            <option value="F">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="solar">æ›†æ³•ï¼š</label>
                        <select id="solar" name="solar" required>
                            <option value="true" selected>å…¬æ›†</option>
                            <option value="false">è¾²æ›†</option>
                        </select>
                    </div>
                </div>
                
                <div class="preset-buttons">
                    <strong>å¿«é€Ÿæ¸¬è©¦æ•¸æ“šï¼š</strong><br>
                    <button type="button" class="btn btn-secondary" onclick="loadPreset1()">æ¸¬è©¦æ•¸æ“š 1</button>
                    <button type="button" class="btn btn-secondary" onclick="loadPreset2()">æ¸¬è©¦æ•¸æ“š 2</button>
                    <button type="button" class="btn btn-secondary" onclick="loadPreset3()">æ¸¬è©¦æ•¸æ“š 3</button>
                </div>
                
                <button type="button" class="btn" onclick="generateChart()">ç”Ÿæˆå‘½ç›¤</button>
                <button type="button" class="btn btn-secondary" onclick="clearChart()">æ¸…ç©ºå‘½ç›¤</button>
                <button type="button" class="btn btn-secondary" onclick="showDebugInfo()">èª¿è©¦ä¿¡æ¯</button>
            </form>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ å‘½ç›¤é¡¯ç¤ºå€åŸŸ</h2>
            <div id="status" class="status info">æº–å‚™å°±ç·’ï¼Œè«‹è¼¸å…¥ç”Ÿè¾°æ•¸æ“šå¾Œé»æ“Šã€Œç”Ÿæˆå‘½ç›¤ã€</div>
            
            <div class="chart-container">
                <ziwei-chart 
                    id="ziweiChart" 
                    theme="purple" 
                    language="zh-TW"
                    chart-size="auto">
                </ziwei-chart>
            </div>
            
            <div>
                <button type="button" class="btn btn-secondary" onclick="testReportGeneration()">æ¸¬è©¦å ±å‘Šç”Ÿæˆ</button>
                <button type="button" class="btn btn-secondary" onclick="showChartActions()">é¡¯ç¤ºæ“ä½œæŒ‰éˆ•</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ èª¿è©¦èˆ‡ç›£æ§</h2>
            <div id="debugInfo" class="debug-info">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <!-- è¼‰å…¥æ–°çš„ Bundle -->
    <script src="https://tungcst.github.io/purplestarmapper/ziwei-chart.bundle.js"></script>
    
    <script>
        // å…¨å±€è®Šé‡
        let chartElement = null;
        let debugLog = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            chartElement = document.getElementById('ziweiChart');
            
            // ç›£è½å‘½ç›¤å…ƒç´ çš„äº‹ä»¶
            if (chartElement) {
                chartElement.addEventListener('reportRequest', handleReportRequest);
                
                // ç›£è½è‡ªå®šç¾©æ¶ˆæ¯
                chartElement.addEventListener('chartReady', function(e) {
                    logDebug('Chart ready event received', e.detail);
                });
                
                chartElement.addEventListener('chartError', function(e) {
                    logDebug('Chart error event received', e.detail);
                    showStatus('å‘½ç›¤æ¸²æŸ“å‡ºéŒ¯: ' + e.detail.message, 'error');
                });
            }
            
            logDebug('Page initialized, ZiweiChartDebug available:', !!window.ZiweiChartDebug);
            
            if (window.ZiweiChartDebug) {
                logDebug('ZiweiChartDebug info:', window.ZiweiChartDebug);
            }
        });

        // é è¨­æ¸¬è©¦æ•¸æ“š
        function loadPreset1() {
            document.getElementById('birthDate').value = '1990-01-15';
            document.getElementById('birthTime').value = '3';
            document.getElementById('gender').value = 'M';
            document.getElementById('solar').value = 'true';
            logDebug('Loaded preset 1');
        }

        function loadPreset2() {
            document.getElementById('birthDate').value = '1985-08-20';
            document.getElementById('birthTime').value = '6';
            document.getElementById('gender').value = 'F';
            document.getElementById('solar').value = 'true';
            logDebug('Loaded preset 2');
        }

        function loadPreset3() {
            document.getElementById('birthDate').value = '1995-12-03';
            document.getElementById('birthTime').value = '0';
            document.getElementById('gender').value = 'M';
            document.getElementById('solar').value = 'true';
            logDebug('Loaded preset 3');
        }

        // ç”Ÿæˆå‘½ç›¤
        function generateChart() {
            try {
                const formData = new FormData(document.getElementById('birthForm'));
                const birthData = {
                    birthDate: formData.get('birthDate'),
                    birthTime: formData.get('birthTime'),
                    gender: formData.get('gender'),
                    solar: formData.get('solar') === 'true'
                };

                logDebug('Generating chart with data:', birthData);
                showStatus('æ­£åœ¨ç”Ÿæˆå‘½ç›¤...', 'info');

                if (chartElement) {
                    chartElement.setAttribute('birth-data', JSON.stringify(birthData));
                    showStatus('å‘½ç›¤æ•¸æ“šå·²æ›´æ–°', 'success');
                } else {
                    throw new Error('Chart element not found');
                }

            } catch (error) {
                logDebug('Error generating chart:', error);
                showStatus('ç”Ÿæˆå‘½ç›¤å¤±æ•—: ' + error.message, 'error');
            }
        }

        // æ¸…ç©ºå‘½ç›¤
        function clearChart() {
            if (chartElement) {
                chartElement.removeAttribute('birth-data');
                showStatus('å‘½ç›¤å·²æ¸…ç©º', 'info');
                logDebug('Chart cleared');
            }
        }

        // æ¸¬è©¦å ±å‘Šç”Ÿæˆ
        function testReportGeneration() {
            if (chartElement) {
                // æ¨¡æ“¬å ±å‘Šç”Ÿæˆè«‹æ±‚
                window.postMessage({
                    target: 'ziwei-chart',
                    action: 'generateReport',
                    payload: 'ziwei'
                }, '*');
                
                showStatus('å·²ç™¼é€å ±å‘Šç”Ÿæˆè«‹æ±‚', 'info');
                logDebug('Report generation test triggered');
            }
        }

        // é¡¯ç¤ºåœ–è¡¨æ“ä½œæŒ‰éˆ•
        function showChartActions() {
            if (chartElement && chartElement.showReportActions) {
                const actions = [
                    { type: 'ziwei', label: 'ç´«å¾®å ±å‘Š' },
                    { type: 'career', label: 'äº‹æ¥­å ±å‘Š' },
                    { type: 'love', label: 'æ„›æƒ…å ±å‘Š' }
                ];
                
                chartElement.showReportActions(actions);
                showStatus('æ“ä½œæŒ‰éˆ•å·²é¡¯ç¤º', 'success');
                logDebug('Chart actions displayed');
            }
        }

        // è™•ç†å ±å‘Šç”Ÿæˆè«‹æ±‚
        function handleReportRequest(event) {
            logDebug('Report request received:', event.detail);
            showStatus(`æ”¶åˆ°${event.detail.reportType}å ±å‘Šè«‹æ±‚`, 'success');
            
            // é€™è£¡å¯ä»¥èª¿ç”¨æ‚¨çš„å¾Œç«¯APIä¾†å¯¦éš›ç”Ÿæˆå ±å‘Š
            // ä¾‹å¦‚ï¼š
            // generateReportAPI(event.detail.birthData, event.detail.reportType)
        }

        // é¡¯ç¤ºèª¿è©¦ä¿¡æ¯
        function showDebugInfo() {
            updateDebugDisplay();
            
            // ä¹Ÿé¡¯ç¤ºç€è¦½å™¨æ§åˆ¶å°ä¿¡æ¯
            console.log('=== æ˜Ÿé€”ç¾…ç›¤èª¿è©¦ä¿¡æ¯ ===');
            console.log('Chart Element:', chartElement);
            console.log('ZiweiChartDebug:', window.ZiweiChartDebug);
            console.log('Debug Log:', debugLog);
            
            if (window.ZiweiChartDebug && window.ZiweiChartDebug.testChart) {
                console.log('Testing chart creation...');
                const testData = window.ZiweiChartDebug.createTestData();
                console.log('Test data:', testData);
            }
        }

        // è¨˜éŒ„èª¿è©¦ä¿¡æ¯
        function logDebug(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                data
            };
            
            debugLog.push(logEntry);
            
            // ä¿æŒæœ€è¿‘50æ¢è¨˜éŒ„
            if (debugLog.length > 50) {
                debugLog.shift();
            }
            
            console.log(`[${timestamp}] ${message}`, data);
        }

        // æ›´æ–°èª¿è©¦é¡¯ç¤º
        function updateDebugDisplay() {
            const debugElement = document.getElementById('debugInfo');
            const logText = debugLog.map(entry => {
                let text = `[${entry.timestamp}] ${entry.message}`;
                if (entry.data) {
                    text += '\n' + JSON.stringify(entry.data, null, 2);
                }
                return text;
            }).join('\n\n');
            
            debugElement.textContent = logText || 'æš«ç„¡èª¿è©¦ä¿¡æ¯';
        }

        // é¡¯ç¤ºç‹€æ…‹ä¿¡æ¯
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            
            logDebug(`Status [${type}]:`, message);
        }

        // å…¨å±€éŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            logDebug('Global error:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
        });

        // ç›£è½ä¾†è‡ª Custom Element çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.source === 'ziwei-chart') {
                logDebug('Message from chart element:', event.data);
            }
        });
    </script>
</body>
</html> 